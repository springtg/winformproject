SELECT SUBSTR(A.IN_YMD, 1, 6) AS IN_MONTH, 
       PKG_SBC_COMMON.FN_GET_CUSTOMER('DS', B.CUST_CD)    AS CUST_NAME,
	   PKG_SBC_COMMON.FN_GET_ITEM_NAME(ITEM_CD)           AS ITEM_NAME,
	   PKG_SBC_COMMON.FN_GET_SPEC_NAME(SPEC_CD)           AS SPEC_NAME,
	   PKG_SBC_COMMON.FN_GET_COLOR_NAME(COLOR_CD)         AS COLOR_NAME,
       
	   SUM(DECODE(A.FACTORY, 'VJ', B.IN_QTY, 0))          AS VJ_IN_QTY, 
	   ROUND(SUM(DECODE(A.FACTORY, 'VJ', B.IN_QTY, 0)*
	       DECODE(B.PUR_CURRENCY, 'USD', PUR_PRICE,
	       PUR_PRICE / PKG_SBP_PURCHASE_ORDER.FN_GET_YMD_RATE(TO_CHAR(LAST_DAY(ADD_MONTHS(TO_DATE(A.IN_YMD), -1)), 'YYYYMMDD')) ) ), 2) AS VJ_PUR_AMOUNT,
	   SUM(DECODE(A.FACTORY, 'VJ', B.IN_QTY, 0)*CBD_PRICE)          AS VJ_CBD_AMOUNT,
	   
	   SUM(DECODE(A.FACTORY, 'QD', B.IN_QTY, 0))          AS QD_IN_QTY,
	   ROUND(SUM(DECODE(A.FACTORY, 'QD', B.IN_QTY, 0)*
	       DECODE(B.PUR_CURRENCY, 'USD', PUR_PRICE,
	       PUR_PRICE / PKG_SBP_PURCHASE_ORDER.FN_GET_YMD_RATE(TO_CHAR(LAST_DAY(ADD_MONTHS(TO_DATE(A.IN_YMD), -1)), 'YYYYMMDD')) ) ), 2) AS QD_PUR_AMOUNT,
	   SUM(DECODE(A.FACTORY, 'QD', B.IN_QTY, 0)*CBD_PRICE)          AS QD_CBD_AMOUNT,
	   
           SUM(DECODE(A.FACTORY, 'VJ', 0, 'QD', 0, B.IN_QTY)) AS CDC_IN_QTY,
	   ROUND(SUM(DECODE(A.FACTORY, 'VJ', 0, 'QD', 0, B.IN_QTY, 0)*
	       DECODE(B.PUR_CURRENCY, 'USD', PUR_PRICE,
	       PUR_PRICE / PKG_SBP_PURCHASE_ORDER.FN_GET_YMD_RATE(TO_CHAR(LAST_DAY(ADD_MONTHS(TO_DATE(A.IN_YMD), -1)), 'YYYYMMDD')) ) ), 2) AS CDC_PUR_AMOUNT,
		   	   
	   SUM(DECODE(A.FACTORY, 'VJ', 0, 'QD', 0, B.IN_QTY, 0))          AS CDC_PUR_AMOUNT,
	   SUM(DECODE(A.FACTORY, 'VJ', 0, 'QD', 0, B.IN_QTY, 0)*CBD_PRICE)          AS CDC_CBD_AMOUNT,
	   
	   B.CUST_CD, 
           B.ITEM_CD, 
	   B.SPEC_CD, 
	   B.COLOR_CD
  FROM SBI_IN_HEAD A, SBI_IN_TAIL B
 WHERE A.FACTORY = B.FACTORY
   AND A.IN_NO   = B.IN_NO
   AND A.IN_YMD  BETWEEN [1;시작일;D] AND [2;종료일;D]
   AND B.CUST_CD  LIKE TRIM([3;거래처코드;T]) || '%'
   AND B.PUR_USER LIKE TRIM([4;등록자;U])     || '%'
 GROUP BY SUBSTR(A.IN_YMD, 1, 6), CUST_CD, ITEM_CD, SPEC_CD, COLOR_CD
 ORDER BY IN_MONTH, CUST_NAME, ITEM_NAME, SPEC_NAME, COLOR_NAME 
   
