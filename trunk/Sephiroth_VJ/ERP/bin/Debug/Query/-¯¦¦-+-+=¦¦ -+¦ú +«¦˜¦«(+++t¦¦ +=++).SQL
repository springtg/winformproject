SELECT NVL(MAX(( SELECT DEPT_NAME FROM NEOMICS.CM_DEPT D WHERE D.DEPT_CD = REQ_DEPT )), REQ_DEPT) AS REQ_DEPT_NAME,
       NVL(MAX(( SELECT DEPT_NAME FROM NEOMICS.CM_DEPT D WHERE D.DEPT_CD = OUT_DEPT )), OUT_DEPT) AS OUT_DEPT_NAME,
       REQ_YMD, 
       PKG_SBC_COMMON.FN_GET_ITEM_NAME(ITEM_CD) AS ITEM_NAME,
       PKG_SBC_COMMON.FN_GET_SPEC_NAME(SPEC_CD) AS SPEC_NAME,
       PKG_SBC_COMMON.FN_GET_COLOR_NAME(COLOR_CD) AS COLOR_NAME,
       PKG_SBC_COMMON.FN_GET_STOCK_UNIT(ITEM_CD) AS ITEM_UNIT,  
       SUM(REQ_QTY) AS REQ_QTY,
       SUM(OUT_QTY) AS OUT_QTY,
       SUM(OUT_QTY * PUR_PRICE) AS OUT_AMOUNT 
  FROM ( 
        SELECT A.REQ_NO, ITEM_CD, SPEC_CD, COLOR_CD,
               A.REQ_YMD, A.REQ_DEPT, SUM(B.REQ_QTY) AS REQ_QTY,
               MAX(( SELECT MAX(REQ_DEPT)
                       FROM SBO_OUT_TAIL C
                      WHERE C.FACTORY = B.FACTORY
                        AND C.REQ_NO  = B.REQ_NO
                        AND C.REQ_SEQ = B.REQ_SEQ )) AS OUT_DEPT, 
               SUM(( SELECT SUM(C.OUT_QTY)
                       FROM SBO_OUT_TAIL C
                      WHERE C.FACTORY = B.FACTORY 
                        AND C.REQ_NO  = B.REQ_NO
                        AND C.REQ_SEQ = B.REQ_SEQ )) AS OUT_QTY,
               PKG_SBO_OUT_PRINT.FN_GET_STOCK_PRICE(A.FACTORY, A.REQ_YMD, B.ITEM_CD, B.SPEC_CD, B.COLOR_CD) AS PUR_PRICE  
          FROM SBP_REQUEST_HEAD A, SBP_REQUEST_TAIL B
         WHERE A.FACTORY      = B.FACTORY
           AND A.REQ_NO       = B.REQ_NO
           AND A.FACTORY      = [1;공장;C;SBC21]
           AND A.REQ_YMD      BETWEEN [2;출고요청일 FROM;D] AND [3;출고요청일 TO;D]
           AND A.REQ_DIVISION  = '20'
           AND B.ITEM_CD IN ( SELECT ITEM_CD FROM SBC_ITEM WHERE SUBSTR(GROUP_CD, 1, 2) IN ( '04', '05' ) )
         GROUP BY A.FACTORY, A.REQ_NO, TO_CHAR(TO_DATE(A.REQ_YMD), 'W'), A.REQ_YMD, A.REQ_DEPT, B.ITEM_CD, B.SPEC_CD, B.COLOR_CD          
       )
 GROUP BY REQ_DEPT, OUT_DEPT, REQ_YMD, ITEM_CD, SPEC_CD, COLOR_CD
 ORDER BY REQ_DEPT, OUT_DEPT